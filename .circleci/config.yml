version: 2.1

orbs:
  awscli: circleci/aws-cli@0.1.11

executors:
  golang:
    docker:
      - image: circleci/golang:1.11.5
    working_directory: /go/src/github.com/cosmos
    environment:
      AWS_DEFAULT_REGION: us-east-1

aliases:
  - &TERRAGRUNT tendermintdev/terragrunt

network: &network
  run:
    name: Applying network configuration
    command: |
      cd testnet-kitchen/conf/network

      apply_config
      rm ~/plan.output

ecs: &ecs
  run:
    name: Applying ecs configuration
    command: |
      export FILES_FOLDER=testnet-kitchen/src/ecs/files

      if [[ -z ${CONFIG_TOML} ]]; then
        echo "Using default config.toml"
        mv $FILES_FOLDER/config.toml.default $FILES_FOLDER/config.toml
      else
        echo $CONFIG_TOML > $FILES_FOLDER/config.toml
      fi

      cd testnet-kitchen/conf/ecs

      apply_config
      rm ~/plan.output


build_env: &build_env
  docker:
    - image: *TERRAGRUNT
  environment:
    AWS_REGION: us-east-1

jobs:
  build:
    <<: *build_env
    steps:
      - checkout
      - *network
      - *ecs

  build_gaia_deps:
    executor: golang
    steps:
      - checkout
    #  - setup_remote_docker:
    #      docker_layer_caching: true
    #  - run:
    #      name: Build simulation image
    #      command: |
    #        cd gaia_simulation
    #        docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
    #        docker build -t tendermintdev/gaia_sim .
    #        docker push tendermintdev/gaia_sim
      - awscli/install
      - awscli/configure:
          profile-name: testnets
      - run:
          name: Start ECS tasks
          command: |
            echo "credential_source = Environment" >> ~/.aws/config
            echo "role_arn = arn:aws:iam::388991194029:role/testnets" >> ~/.aws/config

            aws ecs run-task --profile testnets
                             --cluster gaiad-simulation \
                             --task-definition simulation:1 \
                             --launch-type FARGATE \
                             --network-configuration "awsvpcConfiguration={subnets=[subnet-03a96c201278faf96]}"


workflows:
  version: 2
  ecs_testnet_deployment:
    jobs:
      - build_gaia_deps
