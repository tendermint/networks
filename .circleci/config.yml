version: 2.1

aliases:
  - &TERRAGRUNT tendermintdev/terragrunt
  - &PYTHON python:3.7.2-alpine3.9
  - &GOLANG circleci/golang:1.11.5

executors:
  golang:
    docker:
      - image: *GOLANG
    working_directory: /go/src/github.com/cosmos
    environment:
      AWS_DEFAULT_REGION: us-east-1

  python:
    docker:
      - image: *PYTHON

  terragrunt:
    docker:
      - image: *TERRAGRUNT
    environment:
      AWS_REGION: us-east-1

network: &network
  run:
    name: Applying network configuration
    command: |
      cd testnet-kitchen/conf/network

      apply_config
      rm ~/plan.output

ecs: &ecs
  run:
    name: Applying ecs configuration
    command: |
      export FILES_FOLDER=testnet-kitchen/src/ecs/files

      if [[ -z ${CONFIG_TOML} ]]; then
        echo "Using default config.toml"
        mv $FILES_FOLDER/config.toml.default $FILES_FOLDER/config.toml
      else
        echo $CONFIG_TOML > $FILES_FOLDER/config.toml
      fi

      cd testnet-kitchen/conf/ecs

      apply_config
      rm ~/plan.output

jobs:
  build:
    executor: terragrunt
    steps:
      - checkout
      - *network
      - *ecs

  build_gaia_sim_image:
    executor: golang
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build simulation image
          command: |
            cd gaia_simulation
            docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
            docker build -t tendermintdev/gaia_sim .
            docker push tendermintdev/gaia_sim

  run_simulation:
    executor: python
    steps:
      - checkout
      - run:
          name: Start ECS tasks
          command: |
            pip3 install boto3
            cd testnet-kitchen/src/simulation
            ./run_simulation.py

workflows:
  version: 2
  ecs_testnet_deployment:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master

  gaia_simulation:
    jobs:
      - build_gaia_sim_image
      - run_simulation:
          requires:
            - build_gaia_sim_image
