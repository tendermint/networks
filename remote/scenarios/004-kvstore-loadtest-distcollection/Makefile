INVENTORY?=../../inventory/hosts
TEST_NETWORK?=001-reference
REDEPLOY_BETWEEN_TESTS?=true
START_NUM_CLIENTS?=100
END_NUM_CLIENTS?=1000
INC_NUM_CLIENTS?=100
START_HATCH_RATE?=10
END_HATCH_RATE?=100
INC_HATCH_RATE?=10
RUN_TIME?=60s
RUN_TIMEOUT?=70
FAST_MODE?=false
RESULTS_OUTPUT_DIR?=/tmp/004-kvstore-loadtest-distcollection
LOADTEST_LOG?=$(RESULTS_OUTPUT_DIR)/collection.log
PLOT_RESULTS_DIR?=$(RESULTS_OUTPUT_DIR)/plots
.PHONY: execute plot-results

execute:
	mkdir -p $(RESULTS_OUTPUT_DIR)
	INVENTORY=$(INVENTORY) \
		TEST_NETWORK=$(TEST_NETWORK) \
		REDEPLOY_BETWEEN_TESTS=$(REDEPLOY_BETWEEN_TESTS) \
		START_NUM_CLIENTS=$(START_NUM_CLIENTS) \
		END_NUM_CLIENTS=$(END_NUM_CLIENTS) \
		INC_NUM_CLIENTS=$(INC_NUM_CLIENTS) \
		START_HATCH_RATE=$(START_HATCH_RATE) \
		END_HATCH_RATE=$(END_HATCH_RATE) \
		INC_HATCH_RATE=$(INC_HATCH_RATE) \
		RUN_TIME=$(RUN_TIME) \
		RUN_TIMEOUT=$(RUN_TIMEOUT) \
		FAST_MODE=$(FAST_MODE) \
		RESULTS_OUTPUT_DIR=$(RESULTS_OUTPUT_DIR) \
		LOADTEST_LOG=$(LOADTEST_LOG) \
		./execute_load_test_collection.sh

plot-results:
	mkdir -p $(PLOT_RESULTS_DIR)
	TEST_NETWORK=$(TEST_NETWORK) \
		REDEPLOY_BETWEEN_TESTS=$(REDEPLOY_BETWEEN_TESTS) \
		START_NUM_CLIENTS=$(START_NUM_CLIENTS) \
		END_NUM_CLIENTS=$(END_NUM_CLIENTS) \
		INC_NUM_CLIENTS=$(INC_NUM_CLIENTS) \
		START_HATCH_RATE=$(START_HATCH_RATE) \
		END_HATCH_RATE=$(END_HATCH_RATE) \
		INC_HATCH_RATE=$(INC_HATCH_RATE) \
		RUN_TIME=$(RUN_TIME) \
		RESULTS_OUTPUT_DIR=$(RESULTS_OUTPUT_DIR) \
		PLOT_RESULTS_DIR=$(PLOT_RESULTS_DIR) \
		./plot_results.py
